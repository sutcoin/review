<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SUT 사용 후기 제출</title>
  <style>
    body{font-family:Arial, sans-serif;padding:20px;background:#f3f7fb}
    .card{background:#fff;padding:20px;border-radius:10px;max-width:760px;margin:0 auto;box-shadow:0 6px 18px rgba(20,36,80,0.06)}
    label{display:block;margin-top:12px;font-weight:700}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef9;background:#fbfeff}
    textarea{min-height:120px}
    .right{float:right;width:260px;padding:12px;border:1px dashed #e6eef9;border-radius:8px;background:#fbfeff}
    .btn{background:#0066ff;color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    .muted{background:#fff;border:1px solid #e6eef9;padding:10px 12px;border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2>SUT 사용 후기 제출</h2>
    <p>이미지는 선택입니다. (최대 1장 — 안정화 후 다중 업로드로 확장 가능)</p>

    <form id="mainForm" action="GAS_EXEC_URL" method="post" target="submitFrame">
      <label>닉네임</label>
      <input name="nickname" type="text" placeholder="예: 소미">

      <label>업체명 (사용한 업체)</label>
      <input name="company" type="text" placeholder="예: ○○카페">

      <label>메모 (200자 이내)</label>
      <textarea name="memo" maxlength="200" placeholder="후기"></textarea>

      <div style="margin-top:12px;">
        <label>사진 첨부 (선택)</label>
        <input id="fileInput" type="file" accept="image/*">
        <!-- hidden input으로 base64를 넣어 보냄 -->
        <input id="hiddenImage" name="image" type="hidden" />
      </div>

      <div style="margin-top:14px;">
        <button class="btn" id="submitBtn" type="submit">제출하기</button>
        <button type="button" class="muted" onclick="mainForm.reset();">초기화</button>
      </div>
    </form>

    <iframe name="submitFrame" id="submitFrame" style="display:none;"></iframe>

    <p id="status" style="margin-top:12px;color:#333"></p>
  </div>

  <script>
    // 1) 여기에 배포된 Apps Script 웹 앱 URL을 넣으세요
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxoNKsOfOd_aRg7vmpzySrTSydB9nk6lBD_6M6GysQTvECJ7wKabcuPJsJmWPRRJc9oRA/exec"; // <-- 배포한 web app URL
    document.getElementById('mainForm').action = GAS_URL;

    // 2) 파일 → base64 변환 후 hidden input에 넣기
    document.getElementById('mainForm').addEventListener('submit', function(ev){
      ev.preventDefault();
      document.getElementById('status').innerText = "전송 중... 잠시만 기다려주세요.";

      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        // 이미지 없으면 바로 submit (iframe)
        this.submit();
        return;
      }

      // 파일 크기 체크 (권장 2MB 이하)
      if (file.size > 5*1024*1024) {
        if (!confirm("파일이 큰 편입니다. 계속하시겠습니까?")) {
          document.getElementById('status').innerText = "전송 취소됨";
          return;
        }
      }

      const reader = new FileReader();
      reader.onload = function(evt){
        document.getElementById('hiddenImage').value = evt.target.result; // dataURL
        document.getElementById('mainForm').submit();
      };
      reader.onerror = function(err){
        alert("파일을 읽는 중 오류가 발생했습니다.");
        console.error(err);
      };
      reader.readAsDataURL(file);
    });

    // 3) iframe이 부모창으로 postMessage 보낼 때 받기
    window.addEventListener("message", function(ev){
      try {
        var d = ev.data;
        // 문자열이면 parse 시도
        if (typeof d === "string") {
          try { d = JSON.parse(d); } catch(e){ }
        }
        console.log("postMessage received:", d);
        if (d && d.ok) {
          document.getElementById('status').innerHTML = "제출 완료! 저장 폴더: <a href=\"" + (d.folderUrl || "#") + "\" target=\"_blank\">열기</a>";
        } else {
          document.getElementById('status').innerText = "서버 오류: " + (d && d.message ? d.message : JSON.stringify(d));
        }
      } catch(err) {
        console.error(err);
      }
    }, false);
  </script>
</body>
</html>
