<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SUT 사용 후기 제출 (iframe 전송)</title>
<style>
:root{--bg:#f3f7fb;--card:#fff;--accent:#0066ff;--muted:#6b7785}
body{font-family: "Noto Sans KR", Arial, sans-serif; background:var(--bg); margin:0;padding:28px}
.wrap{max-width:980px;margin:0 auto}
.card{background:var(--card);border-radius:12px;padding:26px;box-shadow:0 8px 24px rgba(20,36,80,0.06)}
label{display:block;font-weight:700;margin:12px 0 6px}
input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #e6eef9;background:#fbfeff;box-sizing:border-box}
textarea{min-height:140px}
.rightBox{border:1px dashed #e6eef9;padding:14px;border-radius:10px;background:#fbfeff}
.btn{background:var(--accent);color:#fff;padding:10px 16px;border-radius:10px;border:0;cursor:pointer}
.mutedBtn{background:#fff;border:1px solid #e6eef9;color:#123;padding:10px 14px;border-radius:10px}
.form-grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
@media(max-width:880px){ .form-grid{grid-template-columns:1fr} .rightBox{order:-1} }
.small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>SUT 사용 후기 제출</h1>
    <p class="small">사진 선택 → 서버에 저장 (최대 10장).</p>

    <!-- 주목: action은 아래 JS에서 세팅합니다. target은 iframe -->
    <form id="mainForm" method="post" enctype="multipart/form-data" target="submitFrame">
      <div class="form-grid">
        <div>
          <label>닉네임</label><input name="nickname" id="nickname" type="text" />
          <label>코드</label><input name="code" id="code" type="text" />
          <label>소속</label><input name="affiliation" id="affiliation" type="text" />
          <label>이용한 업체 *</label><input name="usedStore" id="usedStore" type="text" required />
          <label>업체 링크</label><input name="storeLink" id="storeLink" type="url" />
          <label>후기 (200자 이내)</label><textarea id="description" name="description" maxlength="200"></textarea>

          <div style="margin-top:12px">
            <button id="submitBtn" class="btn" type="button">제출하기</button>
            <button type="button" class="mutedBtn" onclick="document.getElementById('mainForm').reset();">양식 초기화</button>
          </div>
          <p class="small" style="margin-top:10px">제출된 정보는 블로그/유튜브 사례용으로 사용될 수 있습니다.</p>
        </div>

        <div>
          <div class="rightBox">
            <h3 style="margin:0 0 8px">사진 첨부 (최대 10장)</h3>
            <p class="small">권장: 1200px 이하, 파일당 1~2MB</p>
            <!-- name="photos" 여러개 파일 전송 가능 -->
            <input id="files" name="photos" type="file" accept="image/*" multiple style="width:100%" />
            <p class="small" style="margin-top:8px">10장 초과 시 제출 불가</p>
          </div>
        </div>
      </div>
    </form>

    <!-- 숨은 iframe (서버 응답을 여기에 받음) -->
    <iframe name="submitFrame" id="submitFrame" style="display:none;"></iframe>
  </div>
</div>

<script>
(async function(){
  // 배포된 Apps Script exec URL로 바꿔주세요:
  const FORM_ACTION_URL = "https://script.google.com/macros/s/AKfycbyq2fH4W5WbjXWKQoUQ_ZdxXBRY1JeZOilmcY1_m7JRQRLZeL8iQxM0hlrLNdMvnOzq/exec";

  // 폼에 action 설정
  const form = document.getElementById('mainForm');
  form.action = FORM_ACTION_URL;

  const MAX_FILES = 10;
  const fileInput = document.getElementById('files');
  document.getElementById('submitBtn').addEventListener('click', function(){
    // 기본 검증
    if (!document.getElementById('usedStore').value.trim()) {
      alert("이용한 업체를 입력해주세요.");
      return;
    }
    if (fileInput.files.length > MAX_FILES) {
      alert("사진은 최대 10장까지 업로드 가능합니다.");
      return;
    }

    // 폼을 submit (브라우저가 직접 전송, CORS 문제 없음)
    this.disabled = true;
    this.textContent = "전송 중...";
    form.submit();

    // iframe으로부터 postMessage 받기: window.addEventListener 아래에서 처리
    setTimeout(()=>{ this.disabled = false; this.textContent = "제출하기"; }, 5000);
  });

  // iframe 메시지 수신(서버가 HTML 안에서 parent.postMessage를 실행해야 함)
  window.addEventListener("message", function(ev){
    try {
      // 서버가 JSON 문자열을 보냈을 경우 처리
      let data = ev.data;
      if (typeof data === "string") {
        try { data = JSON.parse(data); } catch(e) { /* not JSON */ }
      }
      if (data && data.ok) {
        alert("제출 완료!\n저장 폴더: " + (data.folderUrl || "확인불가"));
        form.reset();
        return;
      }
      if (data && data.ok === false) {
        alert("서버 오류: " + (data.message || JSON.stringify(data)));
        return;
      }
      // 다른 메시지는 무시
    } catch(err){
      console.error("iframe message error", err);
    }
  }, false);

})();
</script>
</body>
</html>
