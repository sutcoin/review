<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SUT 사용 후기 제출</title>
  <style>
    :root{--bg:#f3f7fb;--card:#fff;--accent:#0066ff;--muted:#6b7785}
    body{font-family: "Noto Sans KR", Arial, sans-serif; background:var(--bg); margin:0;padding:28px}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:26px;box-shadow:0 8px 24px rgba(20,36,80,0.06)}
    h1{margin:0 0 8px;font-size:22px;color:#123}
    p.lead{margin:0 0 18px;color:var(--muted)}
    label{display:block;font-weight:700;margin:12px 0 6px}
    input[type=text], input[type=url], textarea {
      width:100%;padding:12px;border-radius:10px;border:1px solid #e6eef9;background:#fbfeff;box-sizing:border-box;
      font-size:14px;color:#123;
    }
    textarea{min-height:140px;resize:vertical}
    .rightBox{border:1px dashed #e6eef9;padding:14px;border-radius:10px;background:#fbfeff}
    .small{font-size:13px;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;padding:10px 16px;border-radius:10px;border:0;cursor:pointer}
    .mutedBtn{background:#fff;border:1px solid #e6eef9;color:#123;padding:10px 14px;border-radius:10px}
    .form-grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
    .full{grid-column:1/-1}
    .note{margin-top:18px;color:var(--muted);font-size:13px}
    .help{font-size:12px;color:#8b97a8;margin-top:6px}
    @media(max-width:880px){ .form-grid{grid-template-columns:1fr} .rightBox{order:-1} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>SUT 사용 후기 제출</h1>
      <p class="lead">SUT 사용 후기를 입력하고 이미지(선택)를 함께 업로드 해주세요. (사진 최대 10장, 후기 200자)</p>

      <form id="mainForm" onsubmit="return handleSubmit(event)">
        <div class="form-grid">
          <div>
            <label>닉네임</label>
            <input id="nickname" name="nickname" type="text" placeholder="예: 소미" autocomplete="name" />

            <label>코드</label>
            <input id="code" name="code" type="text" placeholder="예: 12345" />

            <label>소속</label>
            <input id="affiliation" name="affiliation" type="text" placeholder="예: 대전유성" />

            <label>이용한 업체 <span class="small" style="color:#c33">*</span></label>
            <input id="usedStore" name="usedStore" type="text" placeholder="예: ○○카페" required />

            <label>업체 링크</label>
            <input id="storeLink" name="storeLink" type="url" placeholder="https://..." />

            <label class="full">후기 (200자 이내)</label>
            <textarea id="description" name="description" maxlength="200" placeholder="가게를 소개하거나 후기를 적어주세요. (200자 이내)"></textarea>

            <div style="margin-top:14px;">
              <button type="submit" class="btn">제출하기</button>
              <button type="button" class="mutedBtn" onclick="document.getElementById('mainForm').reset();">양식 초기화</button>
            </div>

            <p class="note">제출된 정보는 유튜브 사례 소개 및 블로그 게시용으로 사용됩니다. 개인정보는 안전하게 처리됩니다.</p>
          </div>

          <div>
            <div class="rightBox">
              <h3 style="margin:0 0 8px">사진 첨부 (최대 10장)</h3>
              <p class="small">권장: 가로/세로 1200px 이하, 파일당 1~2MB 이하</p>
              <input id="files" name="photos" type="file" accept="image/*" multiple style="margin-top:10px;width:100%" />
              <p class="help">※ 여러 장 업로드 시 10장을 초과하면 업로드이 차단됩니다.</p>
            </div>
          </div>
        </div>
      </form>

      <div id="status" class="note"></div>
    </div>
  </div>

<script>
/*
  사용법:
  1) 아래 FORM_ACTION_URL 에 Apps Script web app exec URL 넣기
  2) 배포: Apps Script에서 'Anyone, even anonymous'로 배포해야 동작
*/
const FORM_ACTION_URL = "https://script.google.com/macros/s/AKfycbxoNKsOfOd_aRg7vmpzySrTSydB9nk6lBD_6M6GysQTvECJ7wKabcuPJsJmWPRRJc9oRA/exec"; // <-- 꼭 바꿔주세요

// 파일 관련 제약
const MAX_FILES = 10;
const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB per file 권장

function setStatus(msg, isError) {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.style.color = isError ? '#c33' : '#0a0';
}

async function handleSubmit(evt) {
  evt.preventDefault();
  setStatus("준비 중...", false);

  if (!FORM_ACTION_URL || FORM_ACTION_URL.includes("PUT_YOUR_EXEC_URL_HERE")) {
    alert("서버 URL(FORM_ACTION_URL)이 설정되어 있지 않습니다. Apps Script exec URL을 넣어주세요.");
    return false;
  }

  // 폼 값 모으기
  const nickname = document.getElementById('nickname').value.trim() || "무명";
  const code = document.getElementById('code').value.trim() || "";
  const affiliation = document.getElementById('affiliation').value.trim() || "";
  const usedStore = document.getElementById('usedStore').value.trim();
  const storeLink = document.getElementById('storeLink').value.trim() || "";
  const description = document.getElementById('description').value.trim() || "";

  if (!usedStore) {
    alert("이용한 업체명을 입력해주세요.");
    return false;
  }

  // 파일 읽기 -> base64
  const input = document.getElementById('files');
  const files = Array.from(input.files || []);

  if (files.length > MAX_FILES) {
    alert("사진은 최대 10장까지 업로드 가능합니다.");
    return false;
  }

  // 각 파일을 base64로 읽는다 (작으면 바로)
  setStatus("이미지 인코딩 중...", false);
  const images = [];
  for (let f of files) {
    if (f.size > MAX_FILE_SIZE) {
      if (!confirm(`${f.name} 파일 크기가 ${Math.round(f.size/1024/1024*100)/100}MB 입니다. 계속 업로드하시겠습니까?`)) {
        setStatus("업로드 취소됨", true);
        return false;
      }
    }
    const base64 = await readFileAsBase64(f);
    // base64 string에서 "data:*/*;base64," 접두사 제거
    const commaIndex = base64.indexOf(',');
    const pureBase64 = commaIndex >= 0 ? base64.slice(commaIndex+1) : base64;
    images.push({
      name: f.name,
      mimeType: f.type || 'image/png',
      base64: pureBase64
    });
  }

  // payload 구성
  const payload = {
    nickname, code, affiliation, usedStore, storeLink, description,
    images // array of {name,mimeType,base64}
  };

  setStatus("서버에 전송 중...", false);

  // fetch 전송 (JSON). Apps Script 웹앱은 "Anyone, even anonymous"로 배포되어야 합니다.
  try {
    const res = await fetch(FORM_ACTION_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    // 네트워크 레벨 오류가 아닌 경우 응답을 읽어본다
    const txt = await res.text();
    let data = null;
    try { data = JSON.parse(txt); } catch(e) { data = { ok:false, message: txt }; }

    if (!res.ok || !data || data.ok !== true) {
      console.error("서버 응답(실패):", res.status, txt);
      setStatus("전송 실패: 서버 에러. 콘솔 로그 확인하세요.", true);
      alert("전송 실패: " + (data && data.message ? data.message : res.status + " " + txt));
      return false;
    }

    setStatus("전송 성공! 저장 폴더: " + (data.folderUrl || "확인불가"), false);
    alert("제출 완료되었습니다.");
    document.getElementById('mainForm').reset();
    return true;

  } catch (err) {
    console.error("fetch error:", err);
    setStatus("전송 중 오류가 발생했습니다. (네트워크 또는 서버 문제)", true);
    alert("전송 에러: 네트워크 오류 또는 서버 문제. 콘솔 로그 확인하세요.");
    return false;
  }
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = (e) => reject(e);
    fr.readAsDataURL(file); // data:*/*;base64,XXXXX
  });
}
</script>
</body>
</html>
